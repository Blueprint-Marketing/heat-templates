heat_template_version: 2013-05-23

description: |
  Configures a cloud server with wordpress using chef solo.

parameters:
    stack_id:
        type: string

    key_name:
        type: string

    database_name:
        type: string

    database_username:
        type: string

    database_password:
        type: string

    mysql_root_password:
        type: string

    private_key:
        type: string

    public_key:
        type: string

    wordpress_flavor:
        type: string

    wordpress_server_name:
        type: string

    wordpress_database_username:
        type: string

    wordpress_database_password:
        type: string

    wordpress_username:
        type: string

    wordpress_password:
        type: string

    prefix:
        type: string

    version:
        type: string

    public_sync_key:
        type: string
        description: the key to be used by lsyncd clients

    private_sync_key:
        type: string
        description: the key to be used by the lsyncd server

    ssl_private_key:
        type: string

    ssl_certificate:
        type: string

    ssl_intermediate_key:
        type: string

    wp_auth:
        type: string

    wp_logged_in:
        type: string

    wp_nonce:
        type: string

    wp_secure_auth:
        type: string

    mysql_host:
        type: string

resources:
    wordpress_server:
        type: "Rackspace::Cloud::Server"
        properties:
            flavor: { get_param: wordpress_flavor }
            image: "Ubuntu 12.04 LTS (Precise Pangolin)"
            name: { get_param: wordpress_server_name }
            key_name: {get_param: key_name}

    install_wordpress_apt:
        type: "OS::Heat::ChefSolo"
        properties:
            username: root
            private_key: {get_param: private_key}
            host: {get_attr: [wordpress_server, accessIPv4]}
            Berksfile: |
                site :opscode
                cookbook 'apt',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'apt'
            node:
                run_list: ["recipe[apt]"]

    install_wordpress_make:
        type: "OS::Heat::ChefSolo"
        depends_on: install_wordpress_apt
        properties:
            username: root
            private_key: {get_param: private_key}
            host: {get_attr: [wordpress_server, accessIPv4]}
            Berksfile: |
                site :opscode
                cookbook 'build-essential'
            node:
                run_list: ["recipe[build-essential]"]

    wordpress_master: 
        depends_on: "install_wordpress_make"
        type: "OS::Heat::ChefSolo"
        properties:
            private_key: {get_param: private_key}
            host: {get_attr: [wordpress_server, accessIPv4]}
            Berksfile: |
                site :opscode
                cookbook 'chef-client'
                cookbook 'memcached'
                cookbook 'build-essential'
                cookbook 'apt',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'apt'
                cookbook 'chef-solo-search'
                cookbook 'firewall',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'firewall'
                cookbook 'apache2',
                    git: 'https://github.com/opscode-cookbooks/apache2.git'
                cookbook 'php',
                  git: 'https://github.com/opscode-cookbooks/php.git'
                cookbook 'lsyncd',
                  git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                  rel: 'checkmate-solo-lsyncd'
                cookbook 'varnish',
                  git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                  rel: 'checkmate-solo-varnish'
                cookbook 'monit',
                  git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                  rel: 'monit'
                cookbook 'vsftpd',
                  git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                  rel: 'checkmate-solo-vsftpd'
                cookbook 'wordpress',
                  git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                  rel: 'checkmate-solo-wordpress'

            node:
                deployment:
                    id: {get_param: stack_id}
                wordpress:
                    version: {get_param: version}
                run_list: ["recipe[build-essential]",
                           "recipe[chef-solo-search]",
                           "recipe[firewall]",
                           "recipe[apt]",
                           "recipe[wordpress]",
                           "recipe[lsyncd::install_keys]",
                           "recipe[vsftpd]",
                           "recipe[memcached]"]

            data_bags:
                wordpress:
                    id: {get_param: stack_id}
                    encrypted: true
                    wordpress:
                        database:
                            create_db_user: true
                            create_db: true
                            host: {get_param: mysql_host}
                            database_name: {get_param: database_name}
                            server_root_password: {get_param: mysql_root_password}
                            password: {get_param: database_password}
                            username: {get_param: database_username}
                            prefix: {get_param: prefix}
                        user:
                            name: {get_param: wordpress_username}
                            password: {get_param: wordpress_password}
                            hash: {get_param: wordpress_password}
                        wp_auth: {get_param: wp_auth}
                        wp_logged_in: {get_param: wp_logged_in}
                        wp_nonce: {get_param: wp_nonce}
                        wp_secure_auth: {get_param: wp_secure_auth}
                        path: "/"
                    lsyncd:
                        user:
                            ssh_pub_key: {get_param: public_key}
                            ssh_private_key: {get_param: private_key}
                            name: {get_param: wordpress_username}
                            password: {get_param: wordpress_password}
                        #slaves: [{get_attr: [wordpress_server, privateIPv4]}]
                    apache:
                        domain_name: {get_attr: [wordpress_server, accessIPv4]}
                        path: "/"
                    varnish:
                        master_backend: {get_attr: [wordpress_server, privateIPv4]}
outputs:
    wordpress_private_ip:
        value: {get_attr: [wordpress_server, privateIPv4]}
    wordpress_url:
        value: { get_attr: [wordpress_server, accessIPv4]}
    database_name:
        value: {get_param: database_name}
    database_password:
        value: {get_param: database_password}
    database_username:
        value: {get_param: database_username}
    wordpress_user:
        value: {get_param: wordpress_username}
    wordpress_pass:
        value: {get_param: wordpress_password}
